<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vardiya Formu (Vanilla)</title>
  <style>
    :root{
      --bg1: #f5f7fa;
      --bg2: #c3cfe2;
      --card: #ffffff;
      --accent: #4a90e2;
      --muted: #6b7280;
      --radius: 12px;
    }
    *{box-sizing:border-box}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      padding: 32px;
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card{
      background:var(--card);
      width:100%;
      max-width:780px;
      border-radius:var(--radius);
      padding:26px;
      box-shadow:0 10px 30px rgba(18,38,63,0.08);
    }
    h1{color:var(--accent);margin:0 0 12px 0;text-align:center}
    label{display:block;font-weight:600;margin-top:12px;color:#333}
    .row{
      display:flex;
      gap:12px;
      margin-top:8px;
    }
    .row > *{flex:1}
    input[type="text"], input[type="date"], select{
      padding:10px;border-radius:8px;border:1px solid #e5e7eb;font-size:15px;width:100%;
    }
    .satir{
      background:#fbfdff;border:1px solid #eef2f7;padding:14px;border-radius:10px;margin-top:14px;position:relative;
    }
    .satir .actions{display:flex;gap:8px;margin-top:10px}
    .btn{
      display:inline-block;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600;
    }
    .btn-primary{background:var(--accent);color:white}
    .btn-accent{background:#ff7f50;color:white}
    .btn-ghost{background:transparent;border:1px solid #e5e7eb}
    .preview{display:block;margin-top:10px;max-width:150px;border-radius:8px;border:1px solid #ddd;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
    .remove-btn{position:absolute;right:12px;top:12px;background:#fff;border:1px solid #ffd1d1;color:#b91c1c;padding:6px 8px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:640px){
      .row{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸ“‹ Vardiya KayÄ±t Formu</h1>

    <form id="vardiyaForm">
      <label>Tarih</label>
      <input type="date" id="tarih" name="tarih" required>

      <label>Vardiya</label>
      <select id="vardiya" name="vardiya" required>
        <option value="">SeÃ§iniz</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
      </select>

      <label>Hat</label>
      <select id="hat" name="hat" required>
        <option value="">SeÃ§iniz</option>
        <option value="R1">R1</option><option value="R2">R2</option><option value="R3">R3</option>
      </select>

      <h3 style="color:var(--accent);margin-top:18px">AÃ§Ä±klamalar</h3>
      <div id="aciklamaListesi"></div>

      <div style="display:flex;gap:10px;margin-top:16px">
        <button id="yeniSatirBtn" type="button" class="btn btn-accent">+ Yeni SatÄ±r Ekle</button>
        <button id="kaydetBtn" type="submit" class="btn btn-primary" style="flex:1">Kaydet</button>
      </div>

      <p class="small" style="margin-top:10px">Not: FotoÄŸraf 1MB altÄ± olmalÄ±. FotoÄŸraflar base64 olarak gÃ¶nderilir.</p>
    </form>
  </div>

<script>
  // Backend URL - burayÄ± kendi backend adresinle deÄŸiÅŸtir
  const BACKEND_URL = "https://vardiya-backend.onrender.com/api/kaydet";

  // Ä°Ã§ veri yapÄ±sÄ±: her satÄ±r { id, aciklama, personel, foto }
  const aciklamalar = [];

  const aciklamaListesi = document.getElementById("aciklamaListesi");
  const yeniSatirBtn = document.getElementById("yeniSatirBtn");
  const vardiyaForm = document.getElementById("vardiyaForm");

  // Helper: benzersiz id
  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

  // Yeni satÄ±r DOM + state ekle
  function yeniSatir(initial = {aciklama:"", personel:"", foto:""}) {
    const id = uid();
    const item = { id, ...initial };
    aciklamalar.push(item);

    const div = document.createElement("div");
    div.className = "satir";
    div.dataset.id = id;
    div.innerHTML = `
      <button type="button" class="remove-btn" title="SatÄ±rÄ± Sil">âœ•</button>
      <div class="row">
        <input type="text" placeholder="AÃ§Ä±klama" class="aciklamaInput" />
        <input type="text" placeholder="Personel" class="personelInput" />
      </div>
      <div class="row" style="align-items:center;margin-top:8px">
        <input type="file" accept="image/*" class="fotoInput" />
        <div style="flex:1">
          <div class="small" style="margin-bottom:6px">Ã–nizleme:</div>
          <img src="" alt="preview" class="preview" style="display:none" />
        </div>
      </div>
    `;

    // append
    aciklamaListesi.appendChild(div);

    // elemeleri baÄŸla
    const aciklamaInput = div.querySelector(".aciklamaInput");
    const personelInput = div.querySelector(".personelInput");
    const fotoInput = div.querySelector(".fotoInput");
    const previewImg = div.querySelector(".preview");
    const removeBtn = div.querySelector(".remove-btn");

    // baÅŸlangÄ±Ã§ deÄŸerleri
    aciklamaInput.value = item.aciklama;
    personelInput.value = item.personel;
    if(item.foto){
      previewImg.src = item.foto; previewImg.style.display = "block";
    }

    // input eventleri -> state gÃ¼ncelle
    aciklamaInput.addEventListener("input", (e) => {
      const idx = aciklamalar.findIndex(a => a.id === id);
      if(idx>-1) aciklamalar[idx].aciklama = e.target.value;
    });
    personelInput.addEventListener("input", (e) => {
      const idx = aciklamalar.findIndex(a => a.id === id);
      if(idx>-1) aciklamalar[idx].personel = e.target.value;
    });

    // foto seÃ§imi: base64 oku, preview, state'e kaydet
    fotoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if(!file) return;
      // boyut kontrol (1 MB)
    if (file.size > 10 * 1024 * 1024) { // 10 MB
  alert("LÃ¼tfen 10 MB altÄ± bir fotoÄŸraf seÃ§in.");
  e.target.value = "";
  return;
}

      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result; // data:image/..;base64,...
        previewImg.src = base64;
        previewImg.style.display = "block";
        const idx = aciklamalar.findIndex(a => a.id === id);
        if(idx>-1) aciklamalar[idx].foto = base64;
      };
      reader.readAsDataURL(file);
    });

    // satÄ±rÄ± sil
    removeBtn.addEventListener("click", () => {
      const idx = aciklamalar.findIndex(a => a.id === id);
      if(idx>-1) aciklamalar.splice(idx,1);
      div.remove();
    });

    // scroll to new
    div.scrollIntoView({behavior:"smooth", block:"center"});
    return item;
  }

  // Ä°lk satÄ±rÄ± ekle
  yeniSatir();

  // Buton olaylarÄ±
  yeniSatirBtn.addEventListener("click", () => yeniSatir());

  // Form submit: backend'e POST JSON
  vardiyaForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    // temel alanlar
    const tarih = document.getElementById("tarih").value;
    const vardiya = document.getElementById("vardiya").value;
    const hat = document.getElementById("hat").value;

    if(!tarih || !vardiya || !hat){
      alert("LÃ¼tfen Tarih, Vardiya ve Hat alanlarÄ±nÄ± doldurun.");
      return;
    }

    // gÃ¶nderilecek aciklamalar: sadece dolu satÄ±rlarÄ± al
    const payloadAciklamalar = aciklamalar
      .filter(a => a.aciklama.trim() || a.personel.trim() || a.foto)
      .map(a => ({
        aciklama: a.aciklama || "",
        personel: a.personel || "",
        foto: a.foto || ""
      }));

    if(payloadAciklamalar.length === 0){
      if(!confirm("HiÃ§ aÃ§Ä±klama veya fotoÄŸraf eklemediniz. Yine de kaydetmek istiyor musunuz?")) return;
    }

    const payload = { tarih, vardiya, hat, aciklamalar: payloadAciklamalar };

    try {
      // disable submit button while sending
      const kaydetBtn = document.getElementById("kaydetBtn");
      kaydetBtn.disabled = true;
      kaydetBtn.textContent = "Kaydediliyor...";

      const res = await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if(res.ok){
        alert(data.mesaj || "Veriler kaydedildi.");
        // opsiyonel: formu temizle / yeni sayfa
        // temizle tarih/kalan ve satÄ±rlarÄ± sÄ±fÄ±rla
        document.getElementById("tarih").value = "";
        document.getElementById("vardiya").value = "";
        document.getElementById("hat").value = "";
        aciklamalar.splice(0, aciklamalar.length);
        aciklamaListesi.innerHTML = "";
        yeniSatir();
      } else {
        alert("Sunucu hatasÄ±: " + (data.hata || data.error || JSON.stringify(data)));
      }
    } catch(err){
      console.error(err);
      alert("Ä°stek baÅŸarÄ±sÄ±z: " + err.message);
    } finally {
      const kaydetBtn = document.getElementById("kaydetBtn");
      kaydetBtn.disabled = false;
      kaydetBtn.textContent = "Kaydet";
    }
  });

  // debug: window.aciklamalar ile eriÅŸim
  window.aciklamalar = aciklamalar;
</script>
</body>
</html>
